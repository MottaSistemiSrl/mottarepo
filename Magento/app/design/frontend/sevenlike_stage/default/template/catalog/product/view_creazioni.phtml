<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2013 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/**
 * Product view template
 *
 * @see Mage_Catalog_Block_Product_View
 * @see Mage_Review_Block_Product_View
 */
?>
<?php $_helper = $this->helper('catalog/output'); ?>
<?php $_product = $this->getProduct(); ?>
<?php
$isRivista = false;
$attributeSetModel = Mage::getModel("eav/entity_attribute_set");
$attributeSetModel->load($_product->getAttributeSetId());
if($attributeSetModel->getAttributeSetName() == "Riviste")
{
    $isRivista = true;
}
?>
<?php

$currentCat = Mage::registry('current_category');
if ( $currentCat)
{
    $sibilingsCollection = $currentCat->getProductCollection()
        ->addAttributeToSelect('*')->addUrlRewrite()
        ->addAttributeToSort('position', 'ASC');
    Mage::getSingleton('catalog/product_visibility')->addVisibleInCatalogFilterToCollection($sibilingsCollection);

    Mage::getSingleton('cataloginventory/stock')->addInStockFilterToCollection($sibilingsCollection);


    $siblingsArray = array();
    $prevProduct = null;
    $nextProduct = null;

    foreach($sibilingsCollection as $p)
    {
        $stock_data = $p->getStockItem();
        if ($stock_data["is_in_stock"]!=0)
            $siblingsArray[] = $p;
    }

    if(count($siblingsArray) > 1)
    {
        $i = 0;
        foreach($siblingsArray as $p)
        {

            if($p->getId() == $_product->getId() )
            {
                $nextProduct = isset($siblingsArray[$i+1]) ? $siblingsArray[$i+1] : null;
                $prevProduct = isset($siblingsArray[$i-1]) ? $siblingsArray[$i-1] : null;
                break;
            }
            $i++;
        }
    }
    unset($sibilingsCollection);
}
?>

<?php if($currentCat): ?>
    <a class="return-category" href="<?php echo $currentCat->getUrl(); ?>"><?php echo $this->__("Torna al catalogo") ?></a>
<?php endif; ?>
<div id="nex-prev-link">
    <?php if($prevProduct): ?>
        <a class="prev-product" title="<?php echo $prevProduct->getName(); ?>" href="<?php echo $prevProduct->getProductUrl(); ?>">
            &laquo; <?php echo $this->__('Previous') ?>
        </a>
    <?php endif; ?>

    <?php if($nextProduct): ?>
        <a class="next-product" title="<?php echo $nextProduct->getName(); ?>" href="<?php echo $nextProduct->getProductUrl(); ?>">
            <?php echo $this->__('Next') ?> &raquo;
        </a>
    <?php endif; ?>
</div>
<script type="text/javascript">
    var optionsPrice = new Product.OptionsPrice(<?php echo $this->getJsonConfig() ?>);
</script>
<div id="messages_product_view"><?php echo $this->getMessagesBlock()->getGroupedHtml() ?></div>
<div class="product-name">
    <h1><?php echo $_helper->productAttribute($_product, $_product->getName(), 'name') ?></h1>
</div>
<div class="product-view creazioni">
    <div class="product-essential">
        <div class="product-shop">
            <div class="product-name">
                <?php
                    $cp = Mage::getModel("product/product")
                        ->getCollection()
                        ->addFieldToFilter("id_product", $_product->getId())
                        ->getFirstItem();
                    $customer = Mage::getModel("customer/customer")->load($cp->getIdCustomer());

                    $cartamodello = Mage::getModel("catalog/product")
                        ->getCollection()
                        ->addFieldToFilter("sku", $_product->getSkuCartamodello())
                        ->addAttributeToSelect("livello")
                        ->addUrlRewrite()
                        ->getFirstItem()
                    ;
                ?>
                <?php
                    $pageURL = 'http';
                    if ($_SERVER["HTTPS"] == "on") {$pageURL .= "s";}
                    $pageURL .= "://";
                    if ($_SERVER["SERVER_PORT"] != "80") {
                        $pageURL .= $_SERVER["SERVER_NAME"].":".$_SERVER["SERVER_PORT"].$_SERVER["REQUEST_URI"];
                    } else {
                        $pageURL .= $_SERVER["SERVER_NAME"].$_SERVER["REQUEST_URI"];
                    }
                    $urlPage = $pageURL;
                ?>
                <div class="dati">
                    <?php echo $this->formatDate($_product->getCreatedAt(), Mage::getStoreConfig('blog/blog/dateformat'), false);  ?>
                    <span>by <a href="<?php echo Mage::getUrl('megaforum/index/profile')."id/".$customer->getId() ?>"><?php echo $customer->getSevenlikeNickname(); ?></a></span>
                </div>
                <div class="social">
                    <ul>
                        <li><a class="fb" onclick="window.open('https://www.facebook.com/sharer.php?u=<?php echo $urlPage; ?>', 'titolo', ' width=600, height=300, hidthresizable=yes, status=0, scrollbars=yes, location');"></a></li>
                        <li><a class="tw" onclick="window.open('http://twitter.com/intent/tweet?url=<?php echo $urlPage; ?>', 'titolo', ' width=600, height=300, hidthresizable=yes, status=0, scrollbars=yes, location');"></a></li>
                        <li><a class="gp" onclick="window.open('https://plus.google.com/share?url=<?php echo $urlPage; ?>', 'titolo', ' width=600, height=300, hidthresizable=yes, status=0, scrollbars=yes, location');"></a></li>
                        <li><a class="pt" onclick="window.open('https://pinterest.com/pin/create/button/?url=<?php echo $urlPage; ?>&media=<?php echo $this->helper('catalog/image')->init($_product, 'image')->resize(390, 530); ?>&description=<?php $_helper->productAttribute($_product, nl2br($_product->getDescription()), 'description') ?>', 'titolo', ' width=600, height=300, hidthresizable=yes, status=0, scrollbars=yes, location');"></a></li>
                    </ul>
                </div>
          </div>



            <?php if(!$isRivista && $_product->getTypeId() != 'bundle'): ?>

                <?php if($cartamodello->getId()): ?>
                    <div class="product-options2">
                        <p>Cartamodello: <span><a href="<?php echo $cartamodello->getProductUrl(false); ?>"><?php echo $_product->getSkuCartamodello(); ?></a></span></p>
                    </div>
                <?php elseif($_product->getSkuCartamodello()): ?>
                    <div class="product-options2">
                        <p>Cartamodello: <span><?php echo $_product->getSkuCartamodello(); ?></span></p>
                    </div>
                <?php endif; ?>

                    <?php if($cartamodello->getId()): ?>
                        <div class="product-options2">
                            <p>Livello: <span><?php echo $cartamodello->getAttributeText('livello'); ?></span></p>
                        </div>
                    <?php endif; ?>
                <?php if($_product->getMaterialeUtilizzato() != null): ?>
                    <div class="product-options2">
                        <p>Materiale utlizzato: <span><?php echo $_product->getMaterialeUtilizzato(); ?></span></p>
                    </div>
                <?php endif; ?>
            <?php endif; ?>

            <?php if(!$isRivista && $_product->getTypeId() != 'bundle'): ?>
                <?php echo $this->getReviewsSummaryHtml($_product, false, true)?>
                <?php echo $this->getChildHtml('review_form') ?>
            <?php endif; ?>

                <?php if($_product->getTypeId() != 'bundle'): ?>
                    <div class="product-desc">
                        <p><span>Descrizione:</span> <?php echo $_product->getDescription(); ?></p>
                    </div>
                <?php endif; ?>

        </div>

        <div class="product-img-box">
            <?php echo $this->getChildHtml('media') ?>
        </div>
        <div class="clearer"></div>

        <script type="text/javascript">
            //<![CDATA[
            var productAddToCartForm = new VarienForm('product_addtocart_form');
            productAddToCartForm.submit = function(button, url) {
                if (this.validator.validate()) {
                    var form = this.form;
                    var oldUrl = form.action;

                    if (url) {
                        form.action = url;
                    }
                    var e = null;
                    try {
                        this.form.submit();
                    } catch (e) {
                    }
                    this.form.action = oldUrl;
                    if (e) {
                        throw e;
                    }

                    if (button && button != 'undefined') {
                        button.disabled = true;
                    }
                }
            }.bind(productAddToCartForm);

            productAddToCartForm.submitLight = function(button, url){
                if(this.validator) {
                    var nv = Validation.methods;
                    delete Validation.methods['required-entry'];
                    delete Validation.methods['validate-one-required'];
                    delete Validation.methods['validate-one-required-by-name'];
                    // Remove custom datetime validators
                    for (var methodName in Validation.methods) {
                        if (methodName.match(/^validate-datetime-.*/i)) {
                            delete Validation.methods[methodName];
                        }
                    }

                    if (this.validator.validate()) {
                        if (url) {
                            this.form.action = url;
                        }
                        this.form.submit();
                    }
                    Object.extend(Validation.methods, nv);
                }
            }.bind(productAddToCartForm);
            //]]>
        </script>
    </div>

    <div class="spaceBetween"></div>


    <div class="other-products">
        <?php if(!$isRivista): ?>
            <?php echo $this->getChildHtml('upsell_products') ?>
            <?php echo $this->getChildHtml('reports.product.viewed') ?>
        <?php else: ?>
            <?php echo $this->getChildHtml('related_index') ?>
        <?php endif; ?>
    </div>
    <div class="product-sidebar">
        <?php echo $this->getChildHtml("newsletter"); ?>
        <?php echo $this->getChildHtml("spallaDestra"); ?>
    </div>
    <?php echo $this->getChildHtml("productcomment"); ?>
</div>


